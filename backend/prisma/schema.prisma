generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String           @id @default(uuid())
  email          String           @unique
  password       String
  name           String
  role           UserRole
  department     String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  approvedOffers BudgetaryOffer[] @relation("ApprovedBy")
  createdOffers  BudgetaryOffer[] @relation("CreatedBy")
  approvedPOs    PurchaseOrder[]  @relation("POApprovedBy")
  createdPOs     PurchaseOrder[]  @relation("POCreatedBy")
  linkedLoaFdrs  LOAGeneralFDR[]
}

model BudgetaryOffer {
  id               String      @id @default(uuid())
  offerId          String      @unique
  offerDate        DateTime
  toAuthority      String
  subject          String
  workItems        Json
  termsConditions  String
  documentUrl      String?
  documentHash     String?
  status           OfferStatus
  createdById      String
  approverId       String?
  approvalComments String?
  approvalDate     DateTime?
  approvalHistory  Json[]
  tags             String[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  customerId       String?     @default("CR")
  approver         User?       @relation("ApprovedBy", fields: [approverId], references: [id])
  createdBy        User        @relation("CreatedBy", fields: [createdById], references: [id])
  emailLogs        EmailLog[]
  fdrs             FDR[]
}

model EmailLog {
  id               String         @id @default(uuid())
  budgetaryOfferId String
  to               String[]
  cc               String[]
  bcc              String[]
  subject          String
  content          String
  messageId        String?
  status           EmailStatus
  error            String?
  sentAt           DateTime       @default(now())
  budgetaryOffer   BudgetaryOffer @relation(fields: [budgetaryOfferId], references: [id])

  @@index([budgetaryOfferId])
}

model Site {
  id             String          @id @default(uuid())
  name           String
  code           String          @unique
  zoneId         String
  location       String?
  address        String
  contactPerson  String?
  contactPhone   String?
  contactEmail   String?
  status         SiteStatus      @default(ACTIVE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  loas           LOA[]
  purchaseOrders PurchaseOrder[]
  tenders        Tender[]
  zone           Customer        @relation(fields: [zoneId], references: [id])

  @@unique([name, zoneId])
  @@index([zoneId])
}

model LOA {
  id                     String            @id @default(uuid())
  loaNumber              String            @unique
  loaValue               Float
  siteId                 String?
  deliveryPeriod         Json
  workDescription        String
  documentUrl            String
  tags                   String[]
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  emdAmount              Float?
  hasEmd                 Boolean           @default(false)
  status                 LOAStatus         @default(NOT_STARTED)
  dueDate                DateTime?
  warrantyPeriodMonths   Int?
  warrantyPeriodYears    Int?
  warrantyStartDate      DateTime?
  warrantyEndDate        DateTime?
  orderReceivedDate      DateTime?
  remarks                String?
  tenderNo               String?
  orderPOC               String?
  pocId                  String?
  inspectionAgencyId     String?
  fdBgDetails            String?
  daysToDueDateFromExcel Int?
  tenderId               String?
  hasSd                  Boolean           @default(false)
  sdFdrId                String?           @unique
  hasPg                  Boolean           @default(false)
  pgFdrId                String?           @unique
  recoverablePending     Float             @default(0)
  paymentPending         Float             @default(0)
  manualTotalBilled      Float?
  manualTotalReceived    Float?
  manualTotalDeducted    Float?
  amendments             Amendment[]
  invoices               Invoice[]
  otherDocuments         OtherDocument[]
  site                   Site?             @relation(fields: [siteId], references: [id])
  tender                 Tender?           @relation(fields: [tenderId], references: [id], onDelete: Restrict)
  poc                    POC?              @relation(fields: [pocId], references: [id])
  inspectionAgency       InspectionAgency? @relation(fields: [inspectionAgencyId], references: [id])
  purchaseOrders         PurchaseOrder[]
  sdFdr                  FDR?              @relation("LOASecurityDeposit", fields: [sdFdrId], references: [id])
  pgFdr                  FDR?              @relation("LOAPerformanceGuarantee", fields: [pgFdrId], references: [id])
  generalFdrs            LOAGeneralFDR[]

  @@index([siteId])
  @@index([dueDate])
  @@index([tenderId])
  @@index([pocId])
  @@index([inspectionAgencyId])
  @@index([sdFdrId])
  @@index([pgFdrId])
}

model Amendment {
  id              String   @id @default(uuid())
  amendmentNumber String
  documentUrl     String
  loaId           String
  tags            String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  loa             LOA      @relation(fields: [loaId], references: [id])
}

model OtherDocument {
  id          String   @id @default(uuid())
  title       String
  documentUrl String
  loaId       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  loa         LOA      @relation(fields: [loaId], references: [id], onDelete: Cascade)

  @@index([loaId])
}

model PurchaseOrder {
  id                String              @id @default(uuid())
  poNumber          String              @unique
  siteId            String
  loaId             String
  vendorId          String
  requirementDesc   String
  termsConditions   String
  shipToAddress     String
  baseAmount        Float               @default(0)
  taxAmount         Float               @default(0)
  additionalCharges Json[]
  totalAmount       Float               @default(0)
  notes             String?
  documentUrl       String?
  documentHash      String?
  status            POStatus
  createdById       String
  approverId        String?
  approvalComments  String?
  rejectionReason   String?
  approvalHistory   Json[]
  tags              String[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  approver          User?               @relation("POApprovedBy", fields: [approverId], references: [id])
  createdBy         User                @relation("POCreatedBy", fields: [createdById], references: [id])
  loa               LOA                 @relation(fields: [loaId], references: [id])
  site              Site                @relation(fields: [siteId], references: [id])
  vendor            Vendor              @relation(fields: [vendorId], references: [id])
  items             PurchaseOrderItem[]

  @@index([siteId])
  @@index([loaId])
  @@index([vendorId])
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  itemId          String
  quantity        Float
  unitPrice       Float?
  totalAmount     Float?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  item            Item          @relation(fields: [itemId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  @@index([purchaseOrderId])
  @@index([itemId])
}

model Vendor {
  id             String          @id @default(uuid())
  name           String
  email          String          @unique
  mobile         String
  gstin          String?
  address        String
  bankDetails    Json
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseOrders PurchaseOrder[]
  items          VendorItem[]
}

model Item {
  id          String              @id @default(uuid())
  name        String
  description String?
  unitPrice   Float?
  uom         String
  hsnCode     String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  poItems     PurchaseOrderItem[]
  vendors     VendorItem[]
}

model VendorItem {
  vendorId  String
  itemId    String
  unitPrice Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  item      Item     @relation(fields: [itemId], references: [id])
  vendor    Vendor   @relation(fields: [vendorId], references: [id])

  @@id([vendorId, itemId])
}

model Customer {
  id           String   @id
  name         String
  headquarters String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  sites        Site[]

  @@map("customers")
}

model Tender {
  id                String           @id @default(uuid())
  tenderNumber      String           @unique
  dueDate           DateTime
  description       String
  hasEMD            Boolean          @default(false)
  emdAmount         Float?
  emdBankName       String?
  emdSubmissionDate DateTime?
  emdMaturityDate   DateTime?
  emdDocumentUrl    String?
  emdReleaseStatus  EMDReturnStatus?
  emdReleaseDate    DateTime?
  emdReleaseAmount  Float?
  documentUrl       String?
  tags              String[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  nitDocumentUrl    String?
  status            TenderStatus     @default(ACTIVE)
  siteId            String?
  loas              LOA[]
  site              Site?            @relation(fields: [siteId], references: [id])

  @@index([siteId])
}

model ShippingAddress {
  id        String   @id @default(uuid())
  label     String
  address   String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model POC {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  loas      LOA[]

  @@map("pocs")
}

model InspectionAgency {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  loas      LOA[]

  @@map("inspection_agencies")
}

model Invoice {
  id              String     @id @default(uuid())
  loaId           String
  invoiceNumber   String?
  invoiceAmount   Float?
  amountReceived  Float      @default(0)
  amountDeducted  Float      @default(0)
  deductionReason String?
  billLinks       String?
  remarks         String?
  status          BillStatus @default(REGISTERED)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  invoicePdfUrl   String?
  loa             LOA        @relation(fields: [loaId], references: [id], onDelete: Cascade)

  @@index([loaId])
}

model FDR {
  id              String          @id(map: "EMD_pkey") @default(uuid())
  depositAmount   Float
  dateOfDeposit   DateTime
  maturityDate    DateTime?
  bankName        String          @default("IDBI")
  documentUrl     String?
  extractedData   Json?
  offerId         String?
  tags            String[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  category        FDRCategory     @default(FD)
  accountNo       String?
  fdrNumber       String?
  accountName     String?
  maturityValue   Float?
  contractNo      String?
  contractDetails String?
  poc             String?
  location        String?
  status          FDRStatus       @default(RUNNING)
  offer           BudgetaryOffer? @relation(fields: [offerId], references: [id], map: "EMD_offerId_fkey")
  loaForSD        LOA?            @relation("LOASecurityDeposit")
  loaForPG        LOA?            @relation("LOAPerformanceGuarantee")
  generalLoaLinks LOAGeneralFDR[]

  @@index([offerId])
  @@index([status])
  @@index([maturityDate])
  @@index([category])
  @@map("fdrs")
}

model LOAGeneralFDR {
  id        String   @id @default(uuid())
  loaId     String
  fdrId     String
  linkedAt  DateTime @default(now())
  linkedBy  String?
  loa       LOA      @relation(fields: [loaId], references: [id], onDelete: Cascade)
  fdr       FDR      @relation(fields: [fdrId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [linkedBy], references: [id])

  @@unique([loaId, fdrId])
  @@index([loaId])
  @@index([fdrId])
  @@index([linkedBy])
  @@map("loa_general_fdrs")
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
  USER
  BO_SPECIALIST
  PO_SPECIALIST
}

enum OfferStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

enum EmailStatus {
  SENT
  FAILED
}

enum SiteStatus {
  ACTIVE
  INACTIVE
  UNDER_MAINTENANCE
}

enum LOAStatus {
  NOT_STARTED
  IN_PROGRESS
  SUPPLY_WORK_COMPLETED
  CHASE_PAYMENT
  CLOSED
  SUPPLY_WORK_DELAYED
  APPLICATION_PENDING
  UPLOAD_BILL
  RETRIEVE_EMD_SECURITY
}

enum POStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

enum TenderStatus {
  ACTIVE
  RETENDERED
  CANCELLED
  AWARDED
  NOT_AWARDED
}

enum FDRCategory {
  SD
  PG
  FD
  BG
}

enum FDRStatus {
  RUNNING
  COMPLETED
  CANCELLED
  RETURNED
}

enum EMDReturnStatus {
  PENDING
  RETURNED
  NOT_RETURNED
  RELEASED
  RETAINED_AS_SD
}

enum BillStatus {
  REGISTERED
  RETURNED
  PAYMENT_MADE
}
